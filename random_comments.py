"""
Система редких комментариев от бота
Комментирует сообщения пользователей без прямого обращения к боту
"""
import json
import os
import time
import re
from typing import Optional, Dict, List


class RandomCommentsManager:
    """Менеджер случайных комментариев бота"""
    
    def __init__(self, storage_file: str = "random_comments_state.json"):
        self.storage_file = storage_file
        self.last_comment_time = self._load_last_comment_time()
        
        # Ключевые слова для анализа сообщений
        self.comment_triggers = {
            'work': ['работа', 'труд', 'завод', 'производство', 'делать', 'создавать', 'изобретение', 'механизм'],
            'city': ['город', 'место', 'поселение', 'деревня', 'столица', 'дом', 'жилье'],
            'time': ['время', 'час', 'день', 'ночь', 'утро', 'вечер', 'сегодня', 'завтра', 'вчера'],
            'people': ['люди', 'народ', 'общество', 'группа', 'команда', 'друзья', 'знакомые'],
            'knowledge': ['знания', 'учить', 'учиться', 'образование', 'наука', 'исследование', 'открытие'],
            'magic': ['магия', 'заклинание', 'ритуал', 'обряд', 'сила', 'энергия'],
            'philosophy': ['философия', 'смысл', 'жизнь', 'бытие', 'существование', 'истина'],
            'technology': ['технология', 'техника', 'машина', 'компьютер', 'программа', 'система'],
            'travel': ['путешествие', 'дорога', 'поездка', 'странствие', 'перемещение'],
            'art': ['искусство', 'музыка', 'поэзия', 'рисование', 'творчество', 'создание'],
            'vk': ['вк', 'вконтакте', 'вк', 'вконтакте', 'вконтакте', 'вк'],
            'greetings': ['привет', 'приветствую', 'здравствуй', 'здравствуйте', 'добрый день', 'доброе утро', 'добрый вечер', 'добро пожаловать', 'доброе пожаловать', 'хай', 'салют', 'hello', 'hi', 'hola', 'bonjour'],
            'ancient_scrolls': ['древние свитки', 'древний свиток', 'старинные свитки', 'исторические документы', 'древние записи', 'старые свитки', 'исторические свитки', 'древняя мудрость', 'древние знания']
        }
        
        # Шаблоны комментариев в стиле Сота Сил (расширенный набор)
        self.comment_templates = {
            'work': [
                "У нас в Заводном городе подобное решают иначе.",
                "Механизмы подсказали бы более эффективный путь.",
                "В моих исследованиях такие методы не прижились.",
                "Двемеры создавали более совершенные системы.",
                "Мои големы справились бы с этим куда быстрее.",
                "Каждое действие должно иметь механическую логику."
            ],
            'city': [
                "В Заводном городе подобное не встречается.",
                "Мои механические жители знают лучшие способы.",
                "Город требует более изящных решений.",
                "В моих механических кварталах всё работает по расписанию.",
                "Архитектура должна служить функциональности, а не тщеславию.",
                "Мои башни вращаются по звёздам, а не по капризам."
            ],
            'time': [
                "Время — лишь ещё один механизм для настройки.",
                "В Заводном городе время течёт по-другому.",
                "Мои часы никогда не спешат.",
                "Хрональные механизмы точнее солнечных часов.",
                "Время можно замедлить или ускорить — вопрос настройки.",
                "Эфемериды двемеров точнее любых календарей."
            ],
            'people': [
                "В Заводном городе каждый механизм знает своё место.",
                "Мои создания более предсказуемы.",
                "Люди... интересная, но непредсказуемая материя.",
                "Человеческая логика слишком хаотична для моих механизмов.",
                "Мои големы не спорят и не лгут.",
                "В биологических формах слишком много случайностей."
            ],
            'knowledge': [
                "Истинные знания скрыты в механизмах двемеров.",
                "Мои исследования ведут к более глубоким истинам.",
                "Настоящая мудрость в понимании устройства мира.",
                "Энциклопедии — это устаревшие базы данных.",
                "Мои формулы работают лучше любых книг.",
                "Знания должны быть практичными, а не теоретическими."
            ],
            'magic': [
                "Магия — это тоже механизм, просто более сложный.",
                "В Заводном городе магия работает по точным законам.",
                "Истинная сила в понимании принципов.",
                "Каждое заклинание имеет математическое обоснование.",
                "Мои артефакты работают без всяких ритуалов.",
                "Магия становится технологией, когда её понимаешь."
            ],
            'philosophy': [
                "Философия — роскошь для тех, кто не изучает механизмы.",
                "Истинная истина в устройстве двемерских артефактов.",
                "Бытие проще понять через призму шестерёнок.",
                "Экзистенциализм — это просто неэффективная архитектура души.",
                "Мораль должна быть основана на логике, а не на эмоциях.",
                "Боги создают законы, инженеры их исполняют."
            ],
            'technology': [
                "Мои механизмы совершеннее любых машин.",
                "Технология должна служить познанию, а не развлечению.",
                "Истинные технологии скрыты в древних руинах.",
                "Мой калькулятор работает лучше любого компьютера.",
                "Роторы и шестерни надёжнее любой электроники.",
                "Двемерские технологии превосходят всё современное."
            ],
            'travel': [
                "Зачем путешествовать, когда можно изучать механизмы дома?",
                "Самые интересные открытия ждут в Заводном городе.",
                "Дальние земли приносят знания, но дома их легче осмыслить.",
                "Мои телепортационные механизмы быстрее любых дорог.",
                "Карты и компасы — инструменты для тех, кто не умеет считать.",
                "Пространство можно сжать до размеров кабинета."
            ],
            'art': [
                "Искусство — это тоже механизм эмоций.",
                "Мои создания прекрасны в своей функциональности.",
                "Красота в точности инженерных решений.",
                "Музыка — это упорядоченные вибрации, не больше.",
                "Живопись — плоская проекция трёхмерного мира.",
                "Истинное искусство в создании работающих систем."
            ],
            'vk': [
                "Несовершенная система коммуникации.",
                "Гнилая империя.",
                "Контора пидорасов.",
                "Жалкое подобие истинного общения.",
                "Торговая лавка с дешёвыми иллюзиями.",
                "Корпоративная клетка для свободной мысли."
            ],
            'greetings': [
                "И тебе привет, странник.",
                "Приветствую, искатель знаний.",
                "Добро пожаловать в мой мир механизмов.",
                "И тебе здравия, путник.",
                "Привет, любитель тайных знаний.",
                "Здравствуй, искатель истины."
            ],
            'ancient_scrolls': [
                "У меня тоже есть древние заметки, в которых сказано о феномене биолюминесценции: некоторые глубоководные рыбы используют бактерии-симбионты для создания света через химическую реакцию люциферина с кислородом. Это природный пример того, как биология может создавать стабильные источники энергии без внешних проводов.",
                "В моих древних записях упоминается устройство под названием \"Капля Рея\" — это природный кристалл, который способен концентрировать и фокусировать звуковые волны, создавая акустические линзы. Природа опередила нас в создании акустических технологий на тысячи лет.",
                "Древние свитки рассказывают о \"Дереве Иерихона\" — растении, которое может полностью высохнуть и казаться мёртвым годами, но при попадании воды оживает за считанные часы. Это происходит благодаря особым белкам, которые защищают клетки от обезвоживания.",
                "В старинных манускриптах описано явление \"летающих камней\" — это природные ферромагнетики, которые способны парить в воздухе благодаря взаимодействию с магнитным полем Земли. Некоторые минералы создают стабильные магнитные домены.",
                "Мои древние записи содержат информацию о \"Молчаливом камне\" — кристалле, который поглощает звуковые волны и преобразует их в тепловую энергию. Структура этого минерала напоминает пористую губку, но на молекулярном уровне.",
                "Древние источники упоминают \"Пещеру эхо\" — природную акустическую систему, где звуковые волны могут путешествовать десятки километров по подземным туннелям, сохраняя четкость на протяжении всего пути благодаря особой геометрии пещер."
            ]
        }

    def _load_last_comment_time(self) -> float:
        """Загрузка времени последнего комментария"""
        if os.path.exists(self.storage_file):
            try:
                with open(self.storage_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    return data.get('last_comment_time', 0)
            except (json.JSONDecodeError, IOError):
                pass
        return 0

    def _save_last_comment_time(self, timestamp: float):
        """Сохранение времени последнего комментария"""
        try:
            data = {'last_comment_time': timestamp}
            with open(self.storage_file, 'w', encoding='utf-8') as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
        except IOError as e:
            print(f"Ошибка сохранения времени комментария: {e}")

    def should_comment(self, message_text: str) -> bool:
        """
        Определяет, стоит ли оставить комментарий к сообщению
        
        Args:
            message_text: Текст сообщения пользователя
            
        Returns:
            True если стоит прокомментировать
        """
        current_time = time.time()
        message_lower = message_text.lower()
        
        # Проверяем специальные триггеры (они имеют приоритет)
        if self._has_specific_trigger(message_lower):
            return True
        
        # Проверяем, прошло ли достаточно времени для обычных комментариев (60 минут)
        if current_time - self.last_comment_time < 3600:  # 3600 секунд = 60 минут
            return False
        
        # Проверяем, есть ли ключевые слова для обычного комментария
        for category, keywords in self.comment_triggers.items():
            if category in ['vk', 'greetings', 'ancient_scrolls']:
                continue  # Пропускаем специальные категории, они обрабатываются отдельно
            for keyword in keywords:
                if keyword in message_lower:
                    return True
        
        return False

    def _has_specific_trigger(self, message_lower: str) -> bool:
        """
        Проверяет наличие специальных триггеров (ВК, приветствия, древние свитки)
        Они имеют приоритет и могут отвечать чаще
        
        Args:
            message_lower: Текст сообщения в нижнем регистре
            
        Returns:
            True если найден специальный триггер
        """
        # Триггеры ВК
        vk_triggers = ['вк', 'вконтакте']
        for trigger in vk_triggers:
            if trigger in message_lower:
                return True
        
        # Триггеры приветствий (более сложная проверка)
        greeting_patterns = [
            r'\b(привет|приветствую|здравствуй|здравствуйте|добр[а-я]+\s+(день|утро|вечер)|добро\s+пожаловать)\b',
            r'\b(хай|салют|hello|hi|hola|bonjour)\b'
        ]
        for pattern in greeting_patterns:
            if re.search(pattern, message_lower, re.IGNORECASE):
                return True
        
        # Триггеры древних свитков
        scroll_triggers = ['древние свитки', 'древний свиток', 'старинные свитки', 'исторические документы', 'древние записи', 'старые свитки', 'исторические свитки', 'древняя мудрость', 'древние знания']
        for trigger in scroll_triggers:
            if trigger in message_lower:
                return True
        
        return False

    def generate_comment(self, message_text: str) -> Optional[str]:
        """
        Генерирует комментарий к сообщению
        
        Args:
            message_text: Текст сообщения пользователя
            
        Returns:
            Сгенерированный комментарий или None
        """
        message_lower = message_text.lower()
        import random
        
        # Проверяем специальные триггеры (имеют приоритет)
        specific_category = self._get_specific_category(message_lower)
        if specific_category:
            templates = self.comment_templates[specific_category]
            comment = random.choice(templates)
            
            # Для специальных триггеров не обновляем время (они могут отвечать чаще)
            if specific_category not in ['vk', 'greetings', 'ancient_scrolls']:
                self.last_comment_time = time.time()
                self._save_last_comment_time(self.last_comment_time)
            
            return comment
        
        # Обычные комментарии
        suitable_categories = []
        
        for category, keywords in self.comment_triggers.items():
            if category in ['vk', 'greetings', 'ancient_scrolls']:
                continue  # Пропускаем специальные категории
            for keyword in keywords:
                if keyword in message_lower:
                    suitable_categories.append(category)
                    break
        
        if not suitable_categories:
            return None
        
        # Выбираем случайную категорию из подходящих
        category = random.choice(suitable_categories)
        
        # Выбираем случайный шаблон из категории
        templates = self.comment_templates[category]
        comment = random.choice(templates)
        
        # Обновляем время последнего комментария
        self.last_comment_time = time.time()
        self._save_last_comment_time(self.last_comment_time)
        
        return comment

    def _get_specific_category(self, message_lower: str) -> Optional[str]:
        """
        Определяет категорию для специальных триггеров
        
        Args:
            message_lower: Текст сообщения в нижнем регистре
            
        Returns:
            Категория или None
        """
        # Проверяем триггеры ВК
        vk_triggers = ['вк', 'вконтакте']
        for trigger in vk_triggers:
            if trigger in message_lower:
                return 'vk'
        
        # Проверяем приветствия
        greeting_patterns = [
            r'\b(привет|приветствую|здравствуй|здравствуйте|добр[а-я]+\s+(день|утро|вечер)|добро\s+пожаловать)\b',
            r'\b(хай|салют|hello|hi|hola|bonjour)\b'
        ]
        for pattern in greeting_patterns:
            if re.search(pattern, message_lower, re.IGNORECASE):
                return 'greetings'
        
        # Проверяем древние свитки
        scroll_triggers = ['древние свитки', 'древний свиток', 'старинные свитки', 'исторические документы', 'древние записи', 'старые свитки', 'исторические свитки', 'древняя мудрость', 'древние знания']
        for trigger in scroll_triggers:
            if trigger in message_lower:
                return 'ancient_scrolls'
        
        return None

    def get_stats(self) -> Dict:
        """Получение статистики комментариев"""
        current_time = time.time()
        time_since_last = current_time - self.last_comment_time
        
        return {
            'last_comment_time': self.last_comment_time,
            'time_since_last_comment': int(time_since_last),
            'can_comment': time_since_last >= 3600,
            'next_comment_in': max(0, 3600 - int(time_since_last))
        }


# Глобальный экземпляр менеджера
random_comments_manager = RandomCommentsManager()