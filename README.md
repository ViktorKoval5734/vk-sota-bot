# Сота Сил - Бот для ВКонтакте

Мудрый чат-бот с интеграцией Гигачата для бесед ВКонтакте.

## Возможности

- Отвечает на упоминания в беседах
- Сохраняет историю переписки для контекста
- Использует API Гигачата для генерации ответов
- Работает через Callback API (вебхуки)

## Установка

1. Клонируйте репозиторий:
```bash
cd vk_sota_bot
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Скопируйте `.env.example` в `.env` и заполните токены:
```bash
cp .env.example .env
```

## Настройка ВКонтакте

1. Создайте сообщество в ВКонтакте (если ещё нет)
2. Получите токен сообщества:
   - Настройки → Работа с API → Long Poll API → создать токен
   - Разрешения: `messages`, `groups`
3. Включите Callback API:
   - Настройки → Работа с API → Callback API
   - Выберите версию API: `5.199`
   - **ВАЖНО:** Скопируйте код подтверждения, который показывает ВКонтакте
   - Скопируйте URL сервера (пока заглушка)

## Запуск

### Локальный запуск (для тестирования)

1. Запустите туннель ngrok:
```bash
ngrok http 8000
```

2. Скопируйте HTTPS-URL от ngrok

4. В настройках Callback API ВКонтакте:
   - Адрес сервера: `https://ваш-домен.ngrok.io`
   - Секретный ключ: придумайте и сохраните в `.env`
   - **Код подтверждения:** скопируйте из настроек ВКонтакте

5. Обновите код подтверждения в `.env`:
```bash
VK_CONFIRMATION_CODE=код_из_ВКонтакте
```

6. Запустите бота:
```bash
python bot.py
```

7. Введите подтверждение в настройках Callback API

## Обновление кода подтверждения

Если код подтверждения изменился (например, при перенастройке туннеля):

1. **Автоматически:** Обновите переменную `VK_CONFIRMATION_CODE` в `.env` и перезапустите бота
2. **Через API:** Откройте `http://localhost:8000/update_confirmation/новый_код`
3. **Проверка:** Откройте `http://localhost:8000/confirmation_status` для проверки статуса

### Запуск на сервере

1. Настройте домен с HTTPS (Let's Encrypt)
2. Используйте nginx как reverse proxy
3. Настройте systemd-сервис для автозапуска

## Структура проекта

```
vk_sota_bot/
├── bot.py              # Основной код (веб-сервер + логика)
├── gigachat_client.py  # Клиент Гигачата
├── history.py          # Работа с историей
├── config.py           # Конфигурация
├── requirements.txt    # Зависимости
├── .env.example        # Шаблон переменных
├── .env                # Токены (не коммитить!)
└── history.json        # История переписки (создаётся автоматически)
```

## Команды

- Запуск: `python bot.py`
- Остановка: `Ctrl+C`

## Настройка промпта

Измените `SYSTEM_PROMPT` в `config.py`, чтобы настроить поведение бота.

## Решение проблем

1. **Бот не отвечает:**
   - Проверьте токены в `.env`
   - Проверьте логи в консоли
   - Убедитесь, что ngrok запущен

2. **Ошибки API:**
   - Проверьте версию API в `config.py`
   - Убедитесь, что токены валидны

3. **Не работают вебхуки:**
   - Проверьте URL в настройках Callback API
   - Убедитесь, что сервер запущен и доступен

4. **Ошибка "Сервер вернул неправильный ответ":**
   - Убедитесь, что `VK_CONFIRMATION_CODE` в `.env` соответствует коду в настройках ВКонтакте
   - Проверьте статус: `http://localhost:8000/confirmation_status`
   - Обновите код: `http://localhost:8000/update_confirmation/новый_код`

## Диагностика

Для проверки состояния бота доступны следующие endpoints:

- `GET /confirmation_status` - статус кода подтверждения и инструкции
- `GET /update_confirmation/{код}` - обновление кода подтверждения